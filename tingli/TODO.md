# 随睡听 - 睡前磨耳朵听力app

## 功能

- [x] 音频从服务器读取，不打包到app，具体音频目录结构参考本地文件 assets/waiyanshe/catalog.json
- [x] 在 assets/waiyanshe/catalog.json 中增加相应字幕文件目录（支持 .vtt 和 .srt）
- [x] 默认按顺序播放，播放完毕前面文件之后，自动播放后面一个文件
- [x] 播放mp3音频文件时，使用音乐播放器风格界面（胶片/唱片风格），支持播放、暂停、快进、快退、倍速调节
- [x] 增加一个设置页面，可以进行常规习惯设置（每日播放目标）
- [x] 支持设置睡前播放时长，时间到后，自动停止
- [x] 支持打卡功能，检测每日是否达到每日最少播放时长，如果没有，显示提醒
- [x] 记住之前的播放中断位置，再次打开app时，可从上次中断位置继续播放
- [x] 点击字幕，可跳转相应音频位置（通过字幕列表底部弹窗）
- [x] 在cicd文件夹生成上传脚本，打包apk，并上传apk到服务器
- [x] 检查更新：每次app启动时，读取 version.json 文件，判断版本号并提示更新
- [x] 在本地记录播放历史、可查看历史播放列表、可查看当日播放时长
- [x] 生成日历，记录每日打卡情况
- [x] 在明显位置显示当日打卡播放情况，显示是否达标，并支持在设置页面增加达标时长设置
- [x] 不要将所有内容到写到main.dart中，请进行拆分，便于维护（✅ 已完成重构：main.dart从1768行减少到168行，模块化为models、services、pages目录）
- [x] 播放页面显示，同步显示字幕，并根据声音大小、音调高低等显示波浪线或音柱（✅ 已完成：实现了AudioWaveform、CircularWaveform和CurrentSubtitleDisplay组件）
- [x] 在首页列表中，增加播放按钮和详情按钮，如果直接点击首页中的播放按钮，不进入详情页面，并在底部显示类似音乐播放器的 播放、暂停、快进、后退等 dock widget。只有点击详情按钮才会进入详情页面。（✅ 已完成：实现了PlayerService和MiniPlayer）
- [x] 只要当前有播放中音频，无论进入任何页面，都在页面某个位置显示当前播放状态，点击可进入当前播放中音频详情页面，方便随时可暂停或继续播放（✅ 已完成：MiniPlayer在所有页面底部显示）
- [x] 根据当前app主题内容，帮我生成相应的app icon 桌面图标（✅ 已配置：集成flutter_launcher_icons，见APP_ICON_GUIDE.md）
- [x] 在播放详情页面和播放漂浮widget组件，显示当前音频文件播放进度（✅ 已完成：PlayerPage显示进度条和时间，MiniPlayer显示当前时间/总时长）
- [x] 播放详情页面，字幕以类似弹幕的形式，从底部往上滚动显示，支持可上下滚动拖拽字幕，并支持根据字幕位置播放音频（✅ 已完成：实现ScrollableSubtitleWidget，视频右侧显示，见NEW_FEATURES_ADVANCED_REPORT.md）
- [x] 点击播放历史中某条音频，同样支持点击播放和进入音频详情页面（✅ 已完成：历史页面支持播放按钮和详情按钮）
- [x] 首页搜索框支持通过搜索音频字幕文件定位到相应音频文件，并点击搜索结果进行播放（✅ 已完成：实现SubtitleSearchService和SubtitleSearchPage，见NEW_FEATURES_ADVANCED_REPORT.md）
- [x] 点击底部漂浮widget支持 开始播放、停止播放、快进、后退 等操作，并根据音频播放进度，显示当前字幕（✅ 已完成：MiniPlayer显示字幕，PlayerService同步字幕状态）
- [x] 优化首页顶部导航栏，避免按钮过多导致标题显示不全（✅ 已完成：使用PopupMenuButton整合收藏、日历、历史、设置功能，保留搜索和字幕搜索按钮）
- [x] 将App名字修改为 随睡听，在桌面显示 随睡听（✅ 已完成：修改Android和iOS配置）
- [x] 应用启动时，首先检查网络权限是否开启，如果没有，需要请求用户允许，否则无法正常运行，特别是需要在iOS中添加相应请求提示（✅ 已完成：集成connectivity_plus，添加iOS网络使用说明，实现启动时网络检查）
- [x] 在assets/waiyanshe/ 文件夹中增加一个html app下载页面，将下载页面上传到 服务器 /var/www/html/english/ 路径，增加分享功能，支持将此app下载页面链接分享 或者 复制链接（✅ 已完成：创建精美下载页面，支持分享和二维码，已集成到上传脚本）
- [x] 将开发过程中生成的md文档，在tingli 文件夹中创建一个单独文件夹存放（✅ 已完成：创建 docs/ 文件夹，移动15个开发文档，并创建文档索引）
- [x] 点击首页列表中音视频，默认直接播放，并更新相应的播放按钮和底部的漂浮widget，不进入详情页面，只有点击右侧详情按钮才会进入详情页面（✅ 已完成：实现列表项点击直接播放，按钮状态实时同步）
- [x] 点击首页列表音频按钮，可以直接播放，并实时更新播放按钮状态，再次点击列表中播放按钮，可停止播放（✅ 已完成：播放/暂停状态切换正常工作）
- [x] 点击底部漂浮widget支持 开始播放、停止播放、快进、后退 等操作，并根据音频播放进度，显示当前字幕（✅ 已完成：MiniPlayer支持所有基础控制，显示播放进度）
- [x] 首页搜索框迁移到顶部导航栏，默认使用一个搜索按钮，点击之后，才会展开搜索框（✅ 已完成：点击展开TextField，支持实时搜索和清除）
- [x] 在设置页面显示当前音频属于：外研社-新版教材-四上课本听力，便于后期增加更多教材和年级，并支持在设置页面切换（✅ 已完成：实现TextbookManager服务，支持6个年级教材切换。当前已禁用切换功能，仅显示教材信息）
- [ ] 支持多教材切换功能：目前TextbookManager已支持6个年级（三上到五下），但服务器仅提供四上教材数据。需要：1) 上传其他年级的音频和字幕文件到服务器；2) 在catalog.json中配置对应路径；3) 测试各年级切换功能
- [ ] 如果当日未完成设置目标打卡任务，默认在晚上7点，以通知的形式，在手机锁屏显示消息通知、或在消息通知栏显示通知，并支持在设置页面修改提醒时间和提醒次数，并可以设置此提醒是否可关闭（⏳ 已实现NotificationService，需要运行 flutter pub get 安装依赖，见NEW_FEATURES_IMPLEMENTATION.md）
- [ ] 后期增加跟读模式，允许小学生在听的同时，能够跟读重复
- [ ] 复读机模式：可设置重复次数，重复区间，允许小学生重复听某一段录音
- [ ] 面向小学生，修改页面风格，可爱型，优化页面排版设计
- [x] 视频播放详情页面，支持切换字幕显示和隐藏，将视频移动到页面最顶部，将字幕放在视频的下方（✅ 已完成：添加字幕切换按钮，视频在顶部，字幕在下方，Column布局）
- [x] 在设置页面中增加 更新按钮，点击可自动检测是否需要更新，如发现新版，用户点击确定更新按钮之后，开始下载安装新版（✅ 已完成：实现UpdateService，支持版本检查、APK下载、实时进度显示、一键安装，见APP_UPDATE_IMPLEMENTATION.md）
- [x] 记住用户选择的：全部、U1、U2 等，关闭app之后，再次启动时，需要选中，并显示相应列表内容（✅ 已完成：使用SharedPreferences保存unitFilter，启动时自动恢复）
- [x] 隐藏根据关键词搜索字幕内容功能，暂不启用（✅ 已完成：注释掉首页导航栏的字幕搜索按钮）
- [x] 隐藏收藏功能，低优先级（✅ 已完成：注释掉首页PopupMenu中的收藏选项）
- [x] 音频缓存，将下载下来的音频保存在本地，下次播放时，直接从本地播放，避免重新下载（✅ 已完成：实现CacheService，自动下载并缓存到应用文档目录，下次播放优先使用本地文件）
- [x] 支持在设置页面，查看缓存大小，并删除下载的音视频文件，并支持一键清空缓存（✅ 已完成：设置页显示缓存大小，支持一键清空缓存并自动刷新）
- [x] 首次点击播放音频时，需要下载的音频，在下载过程中，需要显示下载进度或loading（✅ 已完成：首页/历史页播放按钮在下载时显示CircularProgressIndicator）
- [x] 点击播放历史列表中的音频，需要参考首页中实现，点击播放按钮可实现播放或停止播放（✅ 已完成：历史页使用ensureCachedAndPlay，支持播放/暂停切换，显示下载进度）
- [x] 暂时隐藏首页上方导航搜索按钮（✅ 已完成：注释掉搜索按钮，保留清除搜索按钮）
- [x] 支持点击查看缓存列表，清空缓存之前，需要用户确认（✅ 已完成：添加确认对话框，显示缓存大小并需要用户确认后才清空）
- [x] 打卡设置中 为什么钟表时间有两圈，请修改为一圈24小时（✅ 已完成：时间选择器强制24小时制并改为输入模式，避免双圈表盘；见 settings_page.dart 的 showTimePicker builder 配置）
- [x] 缓存管理增加支持查看缓存详情（✅ 已完成：新增“缓存详情”页面，支持查看文件路径/大小/时间、下拉刷新、单个删除；设置页点“缓存管理”进入）
- [x] 在首页右上角仅放一个设置按钮即可，更多功能，比如：打卡记录、播放历史等，都放到设置页面查看（✅ 已完成：首页 AppBar 删除更多菜单，仅保留设置按钮；设置页新增“打卡日历/播放历史”入口）
- [x] 为优化体验，减少音频下载时间，在播放当前音视频时，后台提前将列表中下一个音视频下载到缓存。app启动之后，自动下载列表中第一个音频（✅ 已完成：新增 CacheService.prefetch；PlayerService 在开始播放时异步预取下一条；应用启动后自动预取第一条音频，见 main.dart 的 _autoPrefetchFirst）
- [] 美化统一设置页面，比如统一分割线，如果点击有二级页面，则右侧显示向右箭头，提示可查看详情
- [] 将 清空缓存 按钮 放到 缓存详情页面 右上角
- [] 每日最少播放时长 跟 滑动组件之间不要添加分割线
- [x] 每次播放一个音频，记住当前音频的播放状态，当关闭或退出app之后，重新进入app时，需要恢复之前播放的音频，在首页下方的全局播放器显示，点击播放按钮，可继续之前的音频播放（✅ 已完成：实现 saveCurrentPlaybackState() 和 restoreLastPlaybackState() 方法，使用 SharedPreferences 保存播放状态（音频信息、播放位置、时间戳），应用启动时自动恢复并在 MiniPlayer 显示，超过7天的状态自动清除）
- [x] 去掉详情页面的音视频控制相关代码，在底部使用全局miniplayer控制播放状态（✅ 已完成：移除 PlayerPage 内的播放/暂停、上一/下一、快进/快退、倍速等控制，仅保留展示、进度与字幕；控制统一由底部 MiniPlayer 承担；视频/音频 BetterPlayer 仅作为挂载与显示容器）
- [x] 去掉首页列表中 播放按钮和详情按钮，仅使用miniplayer控制播放（✅ 已完成：删除 media_browser_page.dart 中 ListTile 尾部的播放/暂停与详情按钮；点击整行开始播放，控制统一在底部 MiniPlayer 进行；下载中仅显示小型进度圈）
- [x] 支持某个音频循环播放（✅ 已完成：MiniPlayer 新增循环按钮；PlayerService 支持 repeatOne，播放结束时若开启则从头自动重播）
- [] 点击某个音视频之后，如果需要下载，请显示下载进度
- [] 根据分类：word、kewen-audio、kewen-video 将播放详情页面 拆分为 三个不同页面，简化代码，方便维护，在 word单词详情页面，去掉详情页面中间圆形，中间显示单词，课文音频中间部分显示字幕，课文视频页面保持目前样式不变
  - [x] 已拆分并实现：PlayerPageWord / PlayerPageAudio / PlayerPageVideo
  - [x] 视频详情采用单实例放大方案：通过 PlayerService.uiMode(expandedVideo) 让 MiniPlayer 动画展开显示视频画面，避免重复挂载 BetterPlayer
  - [ ] 后续：视频放大模式下将控制栏浮于视频上方，并支持横屏全屏切换
  - [] 设置页面增加分享下载链接：http://www.weiyuai.cn/english/tingli.apk
  - [x] 播放单词详情页面，增加展示字幕
  - [] 播放视频详情页面，顶部视频空白，而且底部miniplay高度不正常
  - [] 首页播放列表中 标题去掉 .mp3、.mp4 后缀
  - [] 当选中全部时，列表中全部音视频循环播放，当选中某个单元，比如 U1/U2/U3... 时，循环播放此单元内的音视频，并支持在设置页面，设置循环播放次数，播放完指定次数之后自动停止
  - [] 合并首页和设置页面中 检查更新函数，统一使用 UpdateService，version.json格式参考 assets/waiyanshe/version.json文件
  - [] 将首页列表中后缀 .mp3/.mp4 去掉

## bug

- [x] 经测试，首页底部播放漂浮widget，点击暂停播放按钮，状态没有更新（✅ 已修复：同步PlayerPage播放事件到PlayerService，立即更新UI状态）
- [x] 经测试，在iOS上应用退到后台之后，播放会自动停止，请在所有app上均支持后台播放（✅ 已修复：配置iOS音频会话和后台模式，Android添加唤醒锁和前台服务权限）
- [] 退出播放详情页面之后，音频停止播放，这是错误的，音频应该一直播放，直到用户点击停止播放按钮。请使用全局播放器播放，防止退出详情页面之后播放停止（未修复修复：MiniPlayer 内挂载隐藏 BetterPlayer，页面退出后控制器仍有效；PlayerService 统一持有控制器并防重复监听，详见 docs/PLAYBACK_STATE_SYNC_FIX.md）
 - [x] 退出播放详情页面之后，音频停止播放，这是错误的，音频应该一直播放，直到用户点击停止播放按钮（✅ 已修复：采用全局播放器模式——MiniPlayer 挂载隐藏 BetterPlayer；PlayerPage 通过 hostedInPlayerPage 标记避免重复挂载；PlayerService 统一持有控制器并防重复监听，详见 docs/PLAYBACK_STATE_SYNC_FIX.md）
- [x] 退到后台之后，音频停止播放，这是错误的，音频应该一直播放，直到用户点击停止播放按钮（✅ 已修复：设置handleLifecycle: false，见BUG_FIX_REPORT.md）
- [x] 手机锁屏之后，音频停止播放，这是错误的，音频应该一直播放，直到用户点击停止播放按钮（✅ 已修复：设置handleLifecycle: false，见BUG_FIX_REPORT.md）
- [] 手机锁屏之后，应该在锁屏页面显示 播放、暂停、前进、后退等按钮（未修复：集成 audio_service，Android/iOS 已配置；在 Player/Service 同步媒体项与播放状态，详见 docs/LOCKSCREEN_AND_REMINDER_IMPLEMENTATION.md）
- [x] 点击首页最底部全局播放器按钮，并不能修改音频播放状态（✅ 已修复：优化togglePlayPause()使用实时状态检查，添加调试日志，见docs/PLAYBACK_STATE_SYNC_FIX.md）
- [x] 点击首页列表中播放按钮，也不能修改播放状态（✅ 已修复：添加100ms延迟和mounted检查，见docs/PLAYBACK_STATE_SYNC_FIX.md）
- [x] 点击首页列表中播放按钮，并不能切换播放状态，即：播放中，点击按钮应该停止播放。停止播放时点击，应该开始或继续播放。同时首页底部全局播放器，也不能准确控制播放状态，点击暂停按钮，音频会继续播放（✅ 已修复：将togglePlayPause()改为异步调用，并在调用后手动刷新UI）
- [x] 点击播放某条音频之后，再查看播放历史列表，不存在播放记录（✅ 已修复：在PlayerService的play()方法中添加HistoryManager.addHistory()调用）
- [x] 设置页面中，打卡提醒设置 请帮我具体实现，不要弹窗提示（✅ 已完成：设置页面使用内联Switch和时间选择器，无弹窗）
- [x] 测试播放音频之后，首页上方的 今日播放 时长没有更新（✅ 已完成：Timer.periodic(15秒) 自动刷新今日播放时长）
- [x] 在音频播放页面，字幕背景太丑，请不要使用黑色背景，可以使用透明背景，修改字幕字体颜色 以美化界面显示（✅ 已完成：subtitlesConfiguration设置透明背景、白色字体、无描边）
- [x] 加快今日播放刷新频率，每次点击一个音频，播放最小1秒 也计入播放进度，只有1秒，也在界面显示进度（✅ 已完成：记录阈值改为1秒，暂停时也记录累积时长）
- [x] 存在bug：首次打开app，点击首页列表中音频播放按钮，音频可以正常播放，但是当点击音频详情，打开音频详情页面，播放音频之后，然后退出音频页面，播放再次点击首页列表中音频，播放失败，点击任意音频都不会播放（✅ 已彻底修复：PlayerPage dispose 时主动销毁专用控制器，触发 PlayerService 重建全局控制器继续播放，解决了控制器生命周期管理问题。见 docs/PLAYER_CONTROLLER_FIX.md）
- [x] 存在bug：首页中，目前选中一个音频，当点击另外一个音频时，如果这个音频需要下载，应该在新选择音频显示loading下载状态，目前会在上一个选中的音频显示loading下载状态，请修复（✅ 已修复：PlayerService 下载状态重构为 per-item Map，确保 loading 正确绑定到选中的音频）
- [x] 将 清空缓存 按钮 放到 缓存详情页面 右上角（✅ 已完成：在 CacheDetailsPage AppBar 添加清空缓存按钮，从设置页移除）
- [x] 每日最少播放时长 跟 滑动组件之间不要添加分割线（✅ 已完成：移除 Slider 之前的分割线，保持视觉连贯性）
- [x] 还是存在这个bug：打开音频详情页面，播放音频之后，然后退出音频详情页面，播放停止。注意：应该使用全局播放器，整个应用都应该只有一个全局播放器。不能将播放器实例放在音频详情页面，否则页面关闭则会销毁播放器实例，进而导致播放停止（✅ 已彻底修复：PlayerPage 不再创建本地控制器，改为使用 PlayerService 的全局控制器。dispose 时不销毁控制器，只是移除监听器并标记不再挂载。整个 app 现在只有一个播放器实例，由 PlayerService 统一管理，见 docs/GLOBAL_PLAYER_REFACTOR.md）
- [x] 整个app应该只有一个全局播放器实例，请检查是否有多余的播放器实例，无论当前切换到任何一个页面或者退出任何页面都不会影响音频播放，除非关闭app（✅ 已完成：验证通过，全局仅 PlayerService 创建控制器，PlayerPage 和 MiniPlayer 仅使用引用，不创建新实例）
- [x] 当在首页点击播放之后，然后点击详情按钮，进入详情页面，页面显示播放状态，但是并没有播放声音，处于停止状态，点击播放按钮，页面处于播放状态，但是没有声音播放（✅ 已修复：
  1) 修复挂载时序：PlayerPage 使用 WidgetsBinding.instance.addPostFrameCallback 延迟设置 hostedInPlayerPage，避免 MiniPlayer 与 PlayerPage 切换期间出现“无挂载点”；
  2) UI 同步：PlayerPage 在监听 PlayerService 变化时先 setState 触发重建，确保 BetterPlayer 立即挂载；
  3) 声音保障：同音频复用时，在确保播放的同时显式 setVolume(1.0)，杜绝静音/0音量导致的“有进度无声音”现象。）
- [] 发现一个bug：在首页点击播放某个音频，然后点击右上角设置按钮，进入设置页面，音频正常播放中，然后返回首页，音频终止。猜测首页再次进入初始化的时候，可能存在bug，请仔细检查
- [] 当在首页点击列表中视频，然后点击miniplayer进入视频播放详情页面，视频正常播放，当时当前关闭视频播放页面时，视频会在首页上方播放，这是错误的，应该随着视频详情页面的关闭，同时关闭视频播放器
- [] 系统启动时，应该检查网络权限是否授权，如果没有需要弹窗用户提醒用户授予网络权限
- [] 发布题目时，需要上传图片、视频或拍照、录屏等，需要请求用户授权。对于iOS用户需要完全请求说明plist文件
- [] iOS实现推送的话，需要请求push token



## 功能说明

### 播放器功能
- **音乐播放器风格界面**：音频文件使用圆形胶片背景和渐变效果
- **视频播放器**：视频文件保持标准播放器界面
- **播放控制**：播放/暂停、上一曲、下一曲、快退10秒、快进10秒
- **倍速播放**：0.5x, 0.75x, 1.0x, 1.25x, 1.5x, 2.0x
- **字幕支持**：自动加载 .vtt 或 .srt 字幕，支持字幕显示和点击跳转
- **顺序播放**：自动按 U1→U2→U3→U4→U5→U6→ACT 顺序播放音频

### 学习辅助
- **播放位置记忆**：每个文件独立记录播放位置，下次继续播放
- **睡前定时器**：10/20/30分钟定时，到时自动暂停
- **每日打卡**：记录每日播放时长，提醒达成目标
- **播放历史**：详细记录每次播放的文件、时间、时长，支持按日期查看
- **打卡日历**：可视化展示每日学习情况，绿色表示已达标，橙色表示未达标
- **今日统计**：首页显示今日播放进度，实时更新达标状态

### 自动更新
- **版本检测**：启动时自动检查新版本
- **一键更新**：点击更新卡片直接下载安装

## 技术实现

### 核心依赖
```yaml
dependencies:
  better_player: ^0.0.83  # 播放器（本地修补版）
  shared_preferences: ^2.0.0  # 本地存储
  http: ^1.0.0  # 网络请求
  package_info_plus: ^4.0.0  # 版本信息
  url_launcher: ^6.0.0  # 外部链接
  intl: ^0.19.0  # 日期格式化
```

### 数据结构
```json
{
  "baseUrl": "https://www.weiyuai.cn/english/waiyanshe/4/up",
  "units": {
    "U1": {
      "word": [...],
      "audio": [...],
      "video": [...]
    }
  }
}
```

### CI/CD 脚本
- `cicd/build_and_upload_key.sh`：SSH密钥认证上传（推荐）
- `cicd/build_and_upload.sh`：密码认证上传

## 待优化功能 🚧

- [ ] 锁屏时，支持在屏幕同步显示字幕（iOS/Android 系统限制，需要使用通知栏或锁屏插件）
- [ ] 添加播放历史记录页面
- [ ] 支持收藏功能
- [ ] 添加播放统计图表
- [ ] 支持离线下载
- [ ] 添加更多主题样式

## 注意事项

1. **better_player 修补**：项目使用本地修补版的 better_player，已修复 Dart 3 兼容性问题
2. **服务器配置**：确保服务器上的音频文件和字幕文件可访问
3. **版本管理**：每次发布需更新 pubspec.yaml 中的版本号
4. **更新检查**：version.json 需手动维护更新日志
